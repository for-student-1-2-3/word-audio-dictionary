<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>単語帳アプリ</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* 基本設定 */
    body {
      font-family: 'Roboto', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f6f9;
      color: #333;
    }
    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #007bff;
      color: white;
      padding: 15px;
      font-size: 1.2rem;
      font-weight: 500;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    button:hover {
      background-color: #0056b3;
      transform: scale(1.05);
    }
    button:active {
      transform: scale(1);
    }
    button:disabled {
      background-color: #b0c4de;
      cursor: not-allowed;
    }
    /* 固定サイズのカード（表・裏とも同じサイズ） */
    .card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 400px;
      height: 250px; /* 固定高さ */
      margin: 20px auto;
      padding: 20px;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    /* 発音の仕方ページ用：改行をそのまま反映、左揃え */
    .instruction {
      white-space: pre-wrap;
      text-align: left;
    }
    /* アクションボタン群 */
    .actions {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }
    #progress, #currentSection {
      text-align: center;
      margin: 20px 0;
      font-size: 1.2rem;
      font-weight: 500;
    }
    #currentSection {
      font-weight: bold;
      color: #007bff;
    }
    /* セクションボタン群 */
    #sections {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
      margin: 20px auto;
      width: 90%;
    }
    /* ハンバーガーメニュー */
    .hamburger-menu {
      position: relative;
    }
    .hamburger-button {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-size: 1rem;
      cursor: pointer;
    }
    .menu-content {
      display: none;
      position: absolute;
      right: 0;
      top: 50px;
      background-color: white;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      min-width: 250px;
      z-index: 1;
      padding: 0; /* 余分な空白をなくす */
    }
    .menu-content button,
    .menu-content label {
      background-color: white;
      color: #333;
      border: none;
      padding: 12px 20px;
      text-align: left;
      width: 100%;
      cursor: pointer;
      font-size: 1rem;
      display: block;
      margin: 0;
    }
    .menu-content button:hover {
      background-color: #f0f8ff;
    }
    /* ファイル入力は非表示 */
    input[type="file"] {
      display: none;
    }
  </style>
</head>
<body>
  <!-- ヘッダー -->
  <div id="header">
    <div>
      <button onclick="shuffleWords()">単語をシャッフル</button>
      <button onclick="resetSection()">リセット</button>
    </div>
    <!-- ハンバーガーメニュー -->
    <div class="hamburger-menu">
      <button class="hamburger-button">≡</button>
      <div class="menu-content">
        <button onclick="exportCSV()">全セクションをエクスポート</button>
        <button onclick="exportMyWordsToCSV()">My単語帳をエクスポート</button>
        <button onclick="document.getElementById('importFileAdd').click()">CSVから追加</button>
        <button onclick="document.getElementById('importFileReplace').click()">CSVで置換</button>
      </div>
    </div>
  </div>

  <!-- インポート用ファイル入力 -->
  <input type="file" id="importFileAdd" accept=".csv" onchange="importCSV(event, 'add')">
  <input type="file" id="importFileReplace" accept=".csv" onchange="importCSV(event, 'replace')">

  <!-- 進捗・セクション表示 -->
  <div id="progress">進捗：---</div>
  <div id="currentSection">セクション: ---</div>

  <!-- カード表示部 -->
  <div class="card">
    <h2 id="wordDisplay">Loading...</h2>
    <p id="meaningDisplay"></p>
    <p id="hintDisplay"></p>
  </div>

  <!-- アクションボタン群 -->
  <div class="actions">
    <!-- 以下のボタン群は、後述の updateActionButtons() により表示切替します -->
    <button id="confirmButton" onclick="showBack()">答えを見る</button>
    <button id="learnedButton" onclick="markAsLearned()">覚えた</button>
    <button id="notLearnedButton" onclick="nextCard()">次へ</button>
    <button id="speakButton" onclick="speakCurrentWord()">発音</button>
    <button id="addToMyWordsButton" onclick="addToMyWords()">My単語帳に追加</button>
    <!-- 発音の仕方ページから単語帳表示へ切り替えるボタン -->
    <button id="showWordListButton" onclick="showWordList()" style="display: none;">単語帳を表示する</button>
  </div>

  <!-- セクション切り替えボタン -->
  <div id="sections"></div>

  <script>
    /********** グローバル変数 **********/
    // 各セクションはオブジェクト { fileName, instruction, words, originalWords, progress }
    let sections = [];
    let currentSectionIndex = null;  // 現在のセクションのインデックス
    let isInstructionView = true;      // 発音の仕方ページ（初期）か、単語帳表示状態か
    let isBackShown = false;           // 単語カードの裏（意味など）が表示されているか（true＝裏、false＝表）
    let currentWordIndex = 0;          // 単語帳表示時の現在の単語インデックス

    /********** ローカルストレージ操作 **********/
    const saveToLocalStorage = (key, value) => localStorage.setItem(key, JSON.stringify(value));
    const loadFromLocalStorage = (key) => JSON.parse(localStorage.getItem(key) || 'null');

    /********** CSVパース処理 **********/
    // CSVは、先頭部分が発音の仕方（instruction）で、"#単語データ"行より前の行全体をinstructionとする
    // "#単語データ"以降が単語データ（各行：ID,英単語,発音記号,品詞,意味）
    function parseCSV(csvText, fileName) {
      const lines = csvText.split(/\r?\n/);
      let instructionLines = [];
      let dataStartIndex = 0;
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line.startsWith("#単語データ")) {
          dataStartIndex = i + 1;
          break;
        }
        if (line !== "") {
          instructionLines.push(line);
        }
      }
      // instruction部分：改行を保持して左揃えで表示するためそのまま結合
      let instruction = instructionLines.join("\n");
      let words = [];
      for (let i = dataStartIndex; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const parts = line.split(',');
        if (parts.length < 5) continue;
        const [id, word, phonetic, partOfSpeech, meaning] = parts;
        words.push({
          id: id.trim(),
          word: word.trim(),
          phonetic: phonetic.trim(),
          partOfSpeech: partOfSpeech.trim(),
          meaning: meaning.trim()
        });
      }
      // 拡張子除去：例 "æの音.csv" → "æの音"
      const fname = fileName.replace(/\.csv$/i, '');
      return {
        fileName: fname,
        instruction: instruction,
        words: words,
        originalWords: words.slice(),
        progress: []
      };
    }

    /********** CSVインポート処理 **********/
    function importCSV(event, mode) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        let csvData = e.target.result;
        if (csvData.charCodeAt(0) === 0xFEFF) {
          csvData = csvData.slice(1);
        }
        const newSection = parseCSV(csvData, file.name);
        if (!newSection) {
          alert("有効なCSVデータがありません。");
          return;
        }
        if (mode === 'replace') {
          sections = [newSection];
        } else if (mode === 'add') {
          sections.push(newSection);
        }
        saveToLocalStorage('sections', sections);
        createSectionButtons();
        alert("CSVデータをインポートしました。");
        loadSection(sections.length - 1);
        event.target.value = "";
      };
      reader.readAsText(file, 'UTF-8');
    }

    /********** My単語帳用処理 **********/
    function loadMyWords() {
      // myWords セクションを作成または更新（重複を避ける）
      let myWords = loadFromLocalStorage('myWords') || [];
      const mySection = {
        fileName: "My単語帳",
        instruction: "My単語帳",
        words: myWords.slice(),
        originalWords: myWords.slice(),
        progress: []
      };
      const myIndex = sections.findIndex(sec => sec.fileName === "My単語帳");
      if (myIndex !== -1) {
        sections[myIndex] = mySection;
      } else {
        sections.push(mySection);
      }
      saveToLocalStorage('sections', sections);
      createSectionButtons();
      currentSectionIndex = sections.findIndex(sec => sec.fileName === "My単語帳");
      isInstructionView = true;
      isBackShown = false;
      currentWordIndex = 0;
      updateSectionDisplay();
      showInstructionView();
    }

    /********** セクションボタン生成 **********/
    function createSectionButtons() {
      const sectionContainer = document.getElementById('sections');
      sectionContainer.innerHTML = '';
      sections.forEach((section, idx) => {
        const button = document.createElement('button');
        // セクション終了（words が空の場合）はボタン色を緑にし、ボタン名に「(完了)」を付与
        if (section.words.length === 0) {
          button.textContent = section.fileName + " (完了)";
          button.style.backgroundColor = 'green';
          button.style.color = 'white';
        } else {
          button.textContent = section.fileName;
          button.style.backgroundColor = '#007bff';
          button.style.color = 'white';
        }
        button.onclick = () => loadSection(idx);
        sectionContainer.appendChild(button);
      });
    }
    createSectionButtons();

    /********** セクション読み込み **********/
    function loadSection(sectionIndex) {
      currentSectionIndex = sectionIndex;
      isInstructionView = true;
      isBackShown = false;
      currentWordIndex = 0;
      updateSectionDisplay();
      showInstructionView();
    }
    function updateSectionDisplay() {
      const currentSectionDisplay = document.getElementById('currentSection');
      if (currentSectionIndex !== null && sections[currentSectionIndex]) {
        currentSectionDisplay.textContent = "セクション: " + sections[currentSectionIndex].fileName;
      } else {
        currentSectionDisplay.textContent = "セクション: ---";
      }
    }
    function updateProgressDisplay() {
      const progressDisplay = document.getElementById('progress');
      if (sections[currentSectionIndex]) {
        const totalOriginal = sections[currentSectionIndex].originalWords.length;
        const learned = sections[currentSectionIndex].progress.length;
        progressDisplay.textContent = `進捗: ${learned} / ${totalOriginal}`;
      } else {
        progressDisplay.textContent = "進捗: ---";
      }
    }

    /********** アクションボタン表示更新 **********/
    function updateActionButtons() {
      // もし instruction view（発音の仕方ページ）なら、すでに「単語帳を表示する」ボタンのみ表示されているので何もしない
      if (isInstructionView) return;
      if (!isBackShown) {
        // 前面表示（英単語のみ）：表示するのは「答えを見る」「次へ」「発音」
        document.getElementById('confirmButton').style.display = 'inline';
        document.getElementById('notLearnedButton').style.display = 'inline';
        document.getElementById('speakButton').style.display = 'inline';
        document.getElementById('learnedButton').style.display = 'none';
        document.getElementById('addToMyWordsButton').style.display = 'none';
      } else {
        // 裏面表示（意味など）：表示するのは「覚えた」「次へ」「発音」「My単語帳に追加」
        document.getElementById('learnedButton').style.display = 'inline';
        document.getElementById('notLearnedButton').style.display = 'inline';
        document.getElementById('speakButton').style.display = 'inline';
        document.getElementById('addToMyWordsButton').style.display = 'inline';
        document.getElementById('confirmButton').style.display = 'none';
      }
    }

    /********** 発音の仕方ページ表示 **********/
    function showInstructionView() {
      isInstructionView = true;
      isBackShown = false;
      const cardTitle = document.getElementById('wordDisplay');
      const meaningDisplay = document.getElementById('meaningDisplay');
      const hintDisplay = document.getElementById('hintDisplay');
      const showWordListButton = document.getElementById('showWordListButton');
      // instruction表示時は、左揃え・改行を反映するためCSSクラスを適用
      cardTitle.className = "instruction";
      cardTitle.textContent = sections[currentSectionIndex].instruction;
      meaningDisplay.textContent = "";
      hintDisplay.textContent = "";
      // 操作ボタンは非表示（instructionページでは「単語帳を表示する」ボタンのみ表示）
      document.getElementById('confirmButton').style.display = 'none';
      document.getElementById('learnedButton').style.display = 'none';
      document.getElementById('notLearnedButton').style.display = 'none';
      document.getElementById('speakButton').style.display = 'none';
      document.getElementById('addToMyWordsButton').style.display = 'none';
      showWordListButton.style.display = 'inline';
      updateProgressDisplay();
    }

    /********** 単語帳表示 **********/
    function showWordList() {
      isInstructionView = false;
      // 単語帳表示時は、前面（英単語のみ）を表示
      isBackShown = false;
      // 表示するボタンは、前面表示用：「答えを見る」「次へ」「発音」
      updateActionButtons();
      // 単語カード表示時は中央揃えに戻す
      document.getElementById('wordDisplay').className = "";
      showCard();
      updateProgressDisplay();
    }

    /********** 単語カード表示（前面） **********/
    function showCard() {
      if (!sections[currentSectionIndex] || isInstructionView) return;
      isBackShown = false;
      updateActionButtons();
      const currentSection = sections[currentSectionIndex];
      const words = currentSection.words;
      if (words.length === 0) {
        document.getElementById('wordDisplay').textContent = "Good Job!";
        document.getElementById('meaningDisplay').textContent = "";
        document.getElementById('hintDisplay').textContent = "";
        return;
      }
      if (currentWordIndex < 0 || currentWordIndex >= words.length) {
        currentWordIndex = 0;
      }
      const wordObj = words[currentWordIndex];
      document.getElementById('wordDisplay').textContent = wordObj.word;
      document.getElementById('meaningDisplay').textContent = "";
      document.getElementById('hintDisplay').textContent = "";
    }

    /********** 答えを見る処理（裏面表示） **********/
    function showBack() {
      if (!sections[currentSectionIndex] || isInstructionView) return;
      isBackShown = true;
      updateActionButtons();
      const words = sections[currentSectionIndex].words;
      if (!words[currentWordIndex]) return;
      const wordObj = words[currentWordIndex];
      // 裏面には意味（品詞付き）と発音記号を表示
      document.getElementById('meaningDisplay').textContent =
        `【${wordObj.partOfSpeech}】 ${wordObj.meaning}`;
      document.getElementById('hintDisplay').textContent =
        `発音記号：${wordObj.phonetic}`;
      // 答えを見ると同時に音声再生
      speakCurrentWord();
    }

    /********** 次の単語 **********/
    function nextCard() {
      if (!sections[currentSectionIndex] || isInstructionView) return;
      const currentSection = sections[currentSectionIndex];
      const words = currentSection.words;
      if (words.length === 0) return;
      currentWordIndex = (currentWordIndex + 1) % words.length;
      // 次へボタンはどちらの場合も前面表示に戻す
      isBackShown = false;
      showCard();
      speakCurrentWord();
      updateProgressDisplay();
      updateActionButtons();
    }

    /********** 発音再生 **********/
    function speakCurrentWord() {
      if (!sections[currentSectionIndex] || isInstructionView) return;
      const words = sections[currentSectionIndex].words;
      if (!words[currentWordIndex]) return;
      const id = words[currentWordIndex].id;
      const audioUrl = `https://for-student-1-2-3.github.io/word-audio-dictionary/audio/${id}.mp3`;
      const audio = new Audio(audioUrl);
      audio.play().catch(error => {
        console.error("Audio playback error:", error);
      });
    }

    /********** 覚えた処理 **********/
    function markAsLearned() {
      if (!sections[currentSectionIndex] || isInstructionView) return;
      const currentSection = sections[currentSectionIndex];
      // My単語帳の場合は、該当単語を localStorage の myWords からも削除する
      if (currentSection.fileName === "My単語帳") {
        let myWords = loadFromLocalStorage('myWords') || [];
        const currentWord = currentSection.words[currentWordIndex];
        myWords = myWords.filter(word => word.id !== currentWord.id);
        saveToLocalStorage('myWords', myWords);
        // 削除後、該当セクションからも削除
        currentSection.words.splice(currentWordIndex, 1);
      } else {
        // 通常セクション：覚えた単語を progress に記録し、words から削除
        currentSection.progress.push(currentWordIndex);
        currentSection.words.splice(currentWordIndex, 1);
      }
      if (currentWordIndex >= currentSection.words.length) {
        currentWordIndex = 0;
      }
      saveToLocalStorage('sections', sections);
      showCard();
      updateProgressDisplay();
      createSectionButtons();
      updateActionButtons();
    }

    /********** 発音記号ボタンは削除（不要） **********/

    /********** シャッフル **********/
    function shuffleWords() {
      if (!sections[currentSectionIndex] || isInstructionView) return;
      const currentSection = sections[currentSectionIndex];
      const words = currentSection.words;
      if (words.length === 0) {
        alert("シャッフルする単語がありません。");
        return;
      }
      for (let i = words.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [words[i], words[j]] = [words[j], words[i]];
      }
      currentWordIndex = 0;
      saveToLocalStorage('sections', sections);
      showCard();
      alert("単語をシャッフルしました。");
    }

    /********** リセット **********/
    function resetSection() {
      if (!sections[currentSectionIndex] || isInstructionView) return;
      const currentSection = sections[currentSectionIndex];
      if (currentSection.fileName === "My単語帳") {
        // My単語帳の場合はリセットすると完全に空にする
        currentSection.words = [];
        currentSection.originalWords = [];
        currentSection.progress = [];
        saveToLocalStorage('myWords', []);
        alert("My単語帳をリセットしました。");
      } else {
        // 通常セクションはオリジナルの単語群から再初期化
        currentSection.words = currentSection.originalWords.slice();
        currentSection.progress = [];
        alert("セクションの進捗をリセットしました。");
      }
      currentWordIndex = 0;
      saveToLocalStorage('sections', sections);
      showCard();
      updateProgressDisplay();
      createSectionButtons();
      updateActionButtons();
    }

    /********** My単語帳への追加 **********/
    function addToMyWords() {
      if (!sections[currentSectionIndex] || isInstructionView) return;
      const words = sections[currentSectionIndex].words;
      if (!words[currentWordIndex]) return;
      const currentWord = words[currentWordIndex];
      let myWords = loadFromLocalStorage('myWords') || [];
      // 重複チェック（IDで判定）
      if (myWords.some(word => word.id === currentWord.id)) {
        alert("この単語は既にMy単語帳に登録されています。");
        return;
      }
      myWords.push(currentWord);
      saveToLocalStorage('myWords', myWords);
      alert(`単語「${currentWord.word}」をMy単語帳に追加しました。`);
    }

    /********** エクスポート処理 **********/
    function exportCSV() {
      let csvContent = "";
      sections.forEach((section) => {
        csvContent += `# セクション: ${section.fileName}\n`;
        section.words.forEach(word => {
          csvContent += `${word.id},${word.word},${word.phonetic},${word.partOfSpeech},${word.meaning}\n`;
        });
        csvContent += "\n";
      });
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'export.csv';
      a.click();
      URL.revokeObjectURL(url);
    }
    function exportMyWordsToCSV() {
      let myWords = loadFromLocalStorage('myWords') || [];
      if (myWords.length === 0) {
        alert("My単語帳にデータがありません。");
        return;
      }
      let csvContent = "";
      myWords.forEach(word => {
        csvContent += `${word.id},${word.word},${word.phonetic},${word.partOfSpeech},${word.meaning}\n`;
      });
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'MyWords.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    /********** ハンバーガーメニューのトグル処理 **********/
    document.querySelector('.hamburger-button').addEventListener('click', (e) => {
      e.stopPropagation();
      const menuContent = document.querySelector('.menu-content');
      menuContent.style.display = (menuContent.style.display === 'block') ? 'none' : 'block';
    });
    document.addEventListener('click', (e) => {
      const menu = document.querySelector('.hamburger-menu');
      if (!menu.contains(e.target)) {
        document.querySelector('.menu-content').style.display = 'none';
      }
    });

    /********** 状態に応じたアクションボタン更新 **********/
    function updateActionButtons() {
      // instruction view（発音の仕方ページ）なら「単語帳を表示する」ボタンのみ表示（既に設定済み）
      if (isInstructionView) return;
      if (!isBackShown) {
        // 前面表示（英単語のみ）：表示するのは「答えを見る」「次へ」「発音」
        document.getElementById('confirmButton').style.display = 'inline';
        document.getElementById('notLearnedButton').style.display = 'inline';
        document.getElementById('speakButton').style.display = 'inline';
        document.getElementById('learnedButton').style.display = 'none';
        document.getElementById('addToMyWordsButton').style.display = 'none';
      } else {
        // 裏面表示（意味など）：表示するのは「覚えた」「次へ」「発音」「My単語帳に追加」
        document.getElementById('learnedButton').style.display = 'inline';
        document.getElementById('notLearnedButton').style.display = 'inline';
        document.getElementById('speakButton').style.display = 'inline';
        document.getElementById('addToMyWordsButton').style.display = 'inline';
        document.getElementById('confirmButton').style.display = 'none';
      }
    }

    /********** 初期化 **********/
    // 初期CSV（サンプル）
    const defaultCSV = `æ	
ェア	
「あ」に「え」が加わった長めの音	
くちびるを横に引っ張り、長めに発音する。
#単語データ 
B01001,add,æd,動詞,加える、（数値を）足す
B01002,after,ˈæfˌtər,前置詞,～のあとに（の）、～以降に
B01003,accident,ˈæksədənt,名詞,事故、災難、偶然の出来事
B01004,action,ˈækʃən,名詞,動作`;

    if (!loadFromLocalStorage('sections')) {
      const defaultSection = parseCSV(defaultCSV, "æの音.csv");
      sections.push(defaultSection);
      saveToLocalStorage('sections', sections);
    } else {
      sections = loadFromLocalStorage('sections');
    }
    // 初期化時、myWords にデータがある場合は My単語帳セクションを更新
    if (loadFromLocalStorage('myWords') && loadFromLocalStorage('myWords').length > 0) {
      loadMyWords();
    }
    loadSection(0);
  </script>
</body>
</html>
