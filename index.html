<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>単語帳アプリ</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* 基本設定 */
    body {
      font-family: 'Roboto', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f6f9;
      color: #333;
    }
    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #007bff;
      color: white;
      padding: 15px;
      font-size: 1.2rem;
      font-weight: 500;
    }
    button {
      padding: 10px 20px;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    button:hover {
      background-color: #0056b3;
      transform: scale(1.05);
    }
    button:active {
      transform: scale(1);
    }
    button:disabled {
      background-color: #b0c4de;
      cursor: not-allowed;
    }
    /* 固定サイズのカード（表・裏とも同じサイズ） */
    .card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 400px;
      height: 250px; /* 固定高さ */
      margin: 20px auto;
      padding: 20px;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    /* アクションボタン群 */
    .actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    #progress, #currentSection {
      text-align: center;
      margin: 20px 0;
      font-size: 1.2rem;
      font-weight: 500;
    }
    #currentSection {
      font-weight: bold;
      color: #007bff;
    }
    /* セクションボタン群 */
    #sections {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
      margin: 20px auto;
      width: 90%;
    }
    /* ハンバーガーメニュー */
    .hamburger-menu {
      position: relative;
    }
    .hamburger-button {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-size: 1rem;
      cursor: pointer;
    }
    .menu-content {
      display: none;
      position: absolute;
      right: 0;
      top: 50px;
      background-color: white;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      min-width: 250px;
      z-index: 1;
      padding: 0; /* 余分な空白をなくす */
    }
    .menu-content button,
    .menu-content label {
      background-color: white;
      color: #333;
      border: none;
      padding: 12px 20px;
      text-align: left;
      width: 100%;
      cursor: pointer;
      font-size: 1rem;
      display: block;
      margin: 0;
    }
    .menu-content button:hover {
      background-color: #f0f8ff;
    }
    input[type="file"] {
      display: none;
    }
  </style>
</head>
<body>
  <div id="header">
    <div>
      <button onclick="shuffleWords()">シャッフル</button>
      <button onclick="resetSection()">リセット</button>
    </div>
    <!-- ハンバーガーメニュー -->
    <div class="hamburger-menu">
      <button class="hamburger-button">≡</button>
      <div class="menu-content">
        <button onclick="exportCSV()">全データをエクスポート</button>
        <button onclick="exportMyWordsToCSV()">My単語帳をエクスポート</button>
        <button onclick="document.getElementById('importFileAdd').click()">CSVから追加</button>
        <button onclick="document.getElementById('importFileReplace').click()">CSVで置換</button>
      </div>
    </div>
  </div>

  <!-- インポート用ファイル入力 -->
  <input type="file" id="importFileAdd" accept=".csv" onchange="importCSV(event, 'add')">
  <input type="file" id="importFileReplace" accept=".csv" onchange="importCSV(event, 'replace')">

  <div id="progress">進捗：---</div>
  <div id="currentSection">セクション: ---</div>

  <div class="card">
    <h2 id="wordDisplay">Loading...</h2>
    <p id="meaningDisplay"></p>
    <p id="hintDisplay"></p>
  </div>

  <div class="actions">
    <button id="confirmButton" onclick="showBack()">答えを見る</button>
    <button id="learnedButton" onclick="markAsLearned()">覚えた</button>
    <button id="notLearnedButton" onclick="nextCard()">次の単語</button>
    <button id="hintButton" onclick="showHint()">ヒント</button>
    <button id="speakButton" onclick="speakCurrentWord()">発音</button>
    <button id="addToMyWordsButton" onclick="addToMyWords()">My単語帳に追加</button>
    <button id="showWordListButton" onclick="showWordList()" style="display: none;">単語帳を表示する</button>
  </div>

  <div id="sections"></div>

  <script>
    /********** グローバル変数など（セクション管理、初期化、CSVパース等）は前回のコードと同様です **********/
    // ※ここでは省略せず、前回提示した全体コードの内容をそのまま利用してください
    // ---（前回のコードの内容）---

    /********** ハンバーガーメニューのトグル処理 修正 **********/
    document.querySelector('.hamburger-button').addEventListener('click', (e) => {
      // クリックイベントの伝播を止める
      e.stopPropagation();
      const menuContent = document.querySelector('.menu-content');
      if (menuContent.style.display === 'block') {
        menuContent.style.display = 'none';
      } else {
        menuContent.style.display = 'block';
      }
    });
    document.addEventListener('click', (e) => {
      const menu = document.querySelector('.hamburger-menu');
      if (!menu.contains(e.target)) {
        document.querySelector('.menu-content').style.display = 'none';
      }
    });

    /********** 以下、前回提示したコードの残りの処理（CSVパース、セクション読み込み、カード表示、操作関数等） **********/
    
    // ここから下は前回提示したコードの該当部分をそのまま使用してください
    // 例：
    let sections = [];
    let currentSectionIndex = null;
    let isInstructionView = true;
    let currentWordIndex = 0;

    const saveToLocalStorage = (key, value) => localStorage.setItem(key, JSON.stringify(value));
    const loadFromLocalStorage = (key) => JSON.parse(localStorage.getItem(key) || 'null');

    // 初期CSV（サンプル）
    const defaultCSV = `æ\tェア\t「あ」に「え」が加わった長めの音\tくちびるを横に引っ張り、長めに発音する。
B01001,add,æd,動詞,加える、（数値を）足す
B01002,after,ˈæfˌtər,前置詞,～のあとに（の）、～以降に
B01003,accident,ˈæksədənt,名詞,事故、災難、偶然の出来事
B01004,action,ˈækʃən,名詞,動作`;

    if (!loadFromLocalStorage('sections')) {
      const defaultSection = parseCSV(defaultCSV, "default.csv");
      sections.push(defaultSection);
      saveToLocalStorage('sections', sections);
    } else {
      sections = loadFromLocalStorage('sections');
    }
    loadSection(0);

    function parseCSV(csvText, fileName) {
      const lines = csvText.trim().split(/\r?\n/);
      if (lines.length === 0) return null;
      let instructionLine = lines[0];
      let instruction = "";
      if (instructionLine.indexOf("\t") !== -1) {
        instruction = instructionLine.split("\t").join("\n");
      } else {
        instruction = instructionLine;
      }
      let words = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const parts = line.split(',');
        if (parts.length < 5) continue;
        const [id, word, phonetic, partOfSpeech, meaning] = parts;
        words.push({
          id: id.trim(),
          word: word.trim(),
          phonetic: phonetic.trim(),
          partOfSpeech: partOfSpeech.trim(),
          meaning: meaning.trim()
        });
      }
      return {
        fileName: fileName,
        instruction: instruction,
        words: words,
        progress: []
      };
    }

    function importCSV(event, mode) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        let csvData = e.target.result;
        if (csvData.charCodeAt(0) === 0xFEFF) {
          csvData = csvData.slice(1);
        }
        const newSection = parseCSV(csvData, file.name);
        if (!newSection) {
          alert("有効なCSVデータがありません。");
          return;
        }
        if (mode === 'replace') {
          sections = [newSection];
        } else if (mode === 'add') {
          sections.push(newSection);
        }
        saveToLocalStorage('sections', sections);
        createSectionButtons();
        alert("CSVデータをインポートしました。");
        loadSection(sections.length - 1);
        event.target.value = "";
      };
      reader.readAsText(file, 'UTF-8');
    }

    function createSectionButtons() {
      const sectionContainer = document.getElementById('sections');
      sectionContainer.innerHTML = '';
      sections.forEach((section, idx) => {
        const button = document.createElement('button');
        button.textContent = section.fileName;
        button.onclick = () => loadSection(idx);
        sectionContainer.appendChild(button);
      });
    }
    createSectionButtons();

    function loadSection(sectionIndex) {
      currentSectionIndex = sectionIndex;
      isInstructionView = true;
      currentWordIndex = 0;
      updateSectionDisplay();
      showInstructionView();
    }
    function updateSectionDisplay() {
      const currentSectionDisplay = document.getElementById('currentSection');
      if (currentSectionIndex !== null && sections[currentSectionIndex]) {
        currentSectionDisplay.textContent = "セクション: " + sections[currentSectionIndex].fileName;
      } else {
        currentSectionDisplay.textContent = "セクション: ---";
      }
    }
    function updateProgressDisplay() {
      const progressDisplay = document.getElementById('progress');
      if (sections[currentSectionIndex]) {
        const total = sections[currentSectionIndex].words.length;
        const learned = sections[currentSectionIndex].progress.length;
        progressDisplay.textContent = `進捗: ${learned} / ${total}`;
      } else {
        progressDisplay.textContent = "進捗: ---";
      }
    }
    function showInstructionView() {
      isInstructionView = true;
      const cardTitle = document.getElementById('wordDisplay');
      const meaningDisplay = document.getElementById('meaningDisplay');
      const hintDisplay = document.getElementById('hintDisplay');
      const showWordListButton = document.getElementById('showWordListButton');
      cardTitle.textContent = sections[currentSectionIndex].instruction;
      meaningDisplay.textContent = "";
      hintDisplay.textContent = "";
      document.getElementById('confirmButton').style.display = 'none';
      document.getElementById('learnedButton').style.display = 'none';
      document.getElementById('notLearnedButton').style.display = 'none';
      document.getElementById('hintButton').style.display = 'none';
      document.getElementById('speakButton').style.display = 'none';
      document.getElementById('addToMyWordsButton').style.display = 'none';
      showWordListButton.style.display = 'inline';
      updateProgressDisplay();
    }
    function showWordList() {
      isInstructionView = false;
      document.getElementById('confirmButton').style.display = 'inline';
      document.getElementById('learnedButton').style.display = 'inline';
      document.getElementById('notLearnedButton').style.display = 'inline';
      document.getElementById('hintButton').style.display = 'inline';
      document.getElementById('speakButton').style.display = 'inline';
      document.getElementById('addToMyWordsButton').style.display = 'inline';
      document.getElementById('showWordListButton').style.display = 'none';
      showCard();
      updateProgressDisplay();
    }
    function showCard() {
      if (!sections[currentSectionIndex] || isInstructionView) return;
      const currentSection = sections[currentSectionIndex];
      const words = currentSection.words;
      if (words.length === 0) {
        document.getElementById('wordDisplay').textContent = "Good Job!";
        document.getElementById('meaningDisplay').textContent = "";
        document.getElementById('hintDisplay').textContent = "";
        return;
      }
      if (currentWordIndex < 0 || currentWordIndex >= words.length) {
        currentWordIndex = 0;
      }
      const wordObj = words[currentWordIndex];
      document.getElementById('wordDisplay').textContent = wordObj.word;
      document.getElementById('meaningDisplay').textContent = "";
      document.getElementById('hintDisplay').textContent = "";
    }
    function showBack() {
      if (!sections[currentSectionIndex] || isInstructionView) return;
      const words = sections[currentSectionIndex].words;
      if (!words[currentWordIndex]) return;
      const wordObj = words[currentWordIndex];
      document.getElementById('meaningDisplay').textContent = 
        `【${wordObj.partOfSpeech}】 ${wordObj.meaning}`;
      document.getElementById('hintDisplay').textContent = 
        `発音記号：${wordObj.phonetic}`;
      speakCurrentWord();
    }
    function nextCard() {
      if (!sections[currentSectionIndex] || isInstructionView) return;
      const currentSection = sections[currentSectionIndex];
      const words = currentSection.words;
      if (words.length === 0) return;
      currentWordIndex = (currentWordIndex + 1) % words.length;
      showCard();
      speakCurrentWord();
      updateProgressDisplay();
    }
    function speakCurrentWord() {
      if (!sections[currentSectionIndex] || isInstructionView) return;
      const words = sections[currentSectionIndex].words;
      if (!words[currentWordIndex]) return;
      const id = words[currentWordIndex].id;
      const audioUrl = `https://for-student-1-2-3.github.io/word-audio-dictionary/audio/${id}.mp3`;
      const audio = new Audio(audioUrl);
      audio.play().catch(error => {
        console.error("Audio playback error:", error);
      });
    }
    function markAsLearned() {
      if (!sections[currentSectionIndex] || isInstructionView) return;
      const currentSection = sections[currentSectionIndex];
      if (!currentSection.progress.includes(currentWordIndex)) {
        currentSection.progress.push(currentWordIndex);
      }
      saveToLocalStorage('sections', sections);
      nextCard();
    }
    function showHint() {
      if (!sections[currentSectionIndex] || isInstructionView) return;
      const words = sections[currentSectionIndex].words;
      if (!words[currentWordIndex]) return;
      document.getElementById('hintDisplay').textContent = 
        `発音記号：${words[currentWordIndex].phonetic}`;
    }
    function shuffleWords() {
      if (!sections[currentSectionIndex] || isInstructionView) return;
      const currentSection = sections[currentSectionIndex];
      const words = currentSection.words;
      if (words.length === 0) {
        alert("シャッフルする単語がありません。");
        return;
      }
      for (let i = words.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [words[i], words[j]] = [words[j], words[i]];
      }
      currentWordIndex = 0;
      saveToLocalStorage('sections', sections);
      showCard();
      alert("単語をシャッフルしました。");
    }
    function resetSection() {
      if (!sections[currentSectionIndex] || isInstructionView) return;
      sections[currentSectionIndex].progress = [];
      currentWordIndex = 0;
      saveToLocalStorage('sections', sections);
      showCard();
      updateProgressDisplay();
      alert("セクションの進捗をリセットしました。");
    }
    function exportCSV() {
      let csvContent = "";
      sections.forEach((section, idx) => {
        csvContent += `# セクション: ${section.fileName}\n`;
        section.words.forEach(word => {
          csvContent += `${word.id},${word.word},${word.phonetic},${word.partOfSpeech},${word.meaning}\n`;
        });
        csvContent += "\n";
      });
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'export.csv';
      a.click();
      URL.revokeObjectURL(url);
    }
    function exportMyWordsToCSV() {
      alert("My単語帳のエクスポートは未実装です。");
    }
    function addToMyWords() {
      alert("My単語帳への追加処理は未実装です。");
    }
  </script>
</body>
</html>
